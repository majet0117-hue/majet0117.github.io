<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplement Oracle v9.5 | Report & Safety Enhanced</title>
    <style>
        :root {
            --primary: #0f172a; --accent: #3b82f6; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --bg: #f8fafc; --card: #ffffff;
            --lane-a: #ecfdf5; --lane-a-border: #059669;
            --lane-b: #fff7ed; --lane-b-border: #f97316;
        }

        * { box-sizing: border-box; font-family: 'Helvetica Neue', Arial, sans-serif; }
        body { background: var(--bg); color: var(--primary); padding: 15px; line-height: 1.6; margin: 0; }
        .container { max-width: 1000px; margin: 0 auto; background: var(--card); padding: 2rem; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }

        h1 { text-align: center; margin-bottom: 0.5rem; font-size: 1.5rem; color: var(--primary); }
        .subtitle { text-align: center; color: #64748b; font-size: 0.85rem; margin-bottom: 2rem; }

        .section-title { font-size: 1.1rem; border-left: 5px solid var(--accent); padding-left: 12px; margin: 30px 0 15px; font-weight: bold; display: flex; align-items: center; justify-content: space-between; }
        
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .pain-grid, .safety-grid, .taken-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 8px; }

        label { display: block; font-size: 0.75rem; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        select, input[type="number"] { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; }
        
        /* Check Cards */
        .check-card { background: #f1f5f9; padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.8rem; border: 2px solid transparent; transition: 0.2s; user-select: none; }
        .check-card:hover { background: #e2e8f0; }
        .check-card:has(input:checked) { border-color: var(--accent); background: #eff6ff; color: var(--accent); font-weight: bold; }
        .taken-card:has(input:checked) { border-color: var(--success); background: #ecfdf5; color: var(--success); }
        .check-card input { margin: 0; }

        /* Button */
        .btn-analyze { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 30px; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-analyze:hover { background: var(--accent); transform: translateY(-2px); }
        
        .advanced-settings { margin-top: 15px; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; }
        .advanced-summary { padding: 10px 15px; background: #f8fafc; font-size: 0.8rem; cursor: pointer; font-weight: bold; color: #64748b; display: flex; justify-content: space-between; }
        .advanced-content { padding: 15px; display: none; background: #fff; border-top: 1px solid #e2e8f0; grid-template-columns: 1fr 1fr; gap: 20px; }
        .advanced-content.show { display: grid; }

        /* Report Tools */
        .report-tools { display: flex; gap: 10px; margin-bottom: 20px; justify-content: flex-end; }
        .btn-tool { padding: 8px 16px; font-size: 0.8rem; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid #cbd5e1; background: #fff; color: #475569; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-tool:hover { background: #f1f5f9; color: var(--primary); }

        /* Results */
        .result-area { margin-top: 40px; display: none; }
        .timeline { border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; margin-bottom: 30px; background: #fff; }
        .time-slot { display: flex; flex-direction: column; border-bottom: 1px solid #f1f5f9; }
        @media (min-width: 600px) { .time-slot { flex-direction: row; } }
        .time-label { width: 100%; background: #f8fafc; padding: 12px; font-size: 0.8rem; font-weight: bold; color: var(--primary); text-align: center; border-bottom: 1px solid #f1f5f9; }
        @media (min-width: 600px) { .time-label { width: 140px; border-bottom: none; border-right: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: center; } }
        .time-content { flex: 1; padding: 10px; display: flex; flex-wrap: wrap; gap: 5px; }
        
        .supp-pill { padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; border: 1px solid; }
        .pill-take { background: var(--lane-a); color: #047857; border-color: #a7f3d0; }
        .pill-add { background: var(--lane-b); color: #c2410c; border-color: #fed7aa; }

        /* Detail Cards */
        .lane-container { margin-bottom: 30px; }
        .lane-header { font-size: 1rem; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .lane-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; color: white; }
        .lane-a-badge { background: var(--success); }
        .lane-b-badge { background: #f97316; }

        .detail-card { background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: relative; }
        .card-lane-a { border-left: 5px solid var(--success); }
        .card-lane-b { border-left: 5px solid #f97316; }
        .detail-card.warning { border: 2px solid var(--danger); background: #fff5f5; }

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .supp-name { font-weight: bold; font-size: 1rem; }
        .supp-score { font-size: 0.75rem; background: #f1f5f9; padding: 2px 8px; border-radius: 12px; color: #64748b; }
        
        .info-row { font-size: 0.85rem; margin-bottom: 4px; display: flex; gap: 10px; align-items: baseline; }
        .info-label { font-weight: bold; color: #64748b; font-size: 0.75rem; min-width: 60px; }
        
        .reason-row { font-size: 0.75rem; color: #64748b; margin-top: 5px; background: rgba(0,0,0,0.02); padding: 4px 8px; border-radius: 4px; }

        .warning-box { margin-top: 10px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; color: var(--danger); font-size: 0.8rem; font-weight: bold; display: block; }
        .warning-line { margin-bottom: 4px; display: flex; align-items: flex-start; gap: 6px; }
        .warning-line:last-child { margin-bottom: 0; }

        .fallback-card { padding: 20px; text-align: left; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 12px; color: #475569; font-size: 0.9rem; }

        /* Print Styles */
        @media print {
            body { background: #fff; padding: 0; color: #000; }
            .container { box-shadow: none; margin: 0; width: 100%; max-width: 100%; border-radius: 0; padding: 0; }
            .grid-inputs, .pain-grid, .safety-grid, .taken-grid, .advanced-settings, .btn-analyze, h1, .subtitle, .report-tools { display: none; }
            .result-area { display: block !important; margin-top: 0; }
            .detail-card { break-inside: avoid; border: 1px solid #ccc; page-break-inside: avoid; }
            .time-slot { page-break-inside: avoid; }
            .lane-header { border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 15px; }
            a { text-decoration: none; color: #000; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SUPPLEMENT ORACLE <span style="font-size:0.5em; vertical-align:top; background:var(--primary); color:white; padding:2px 6px; border-radius:4px;">v9.5</span></h1>
    <div class="subtitle">Evidence-Based & Safety Enhanced</div>
    
    <div class="grid-inputs">
        <div><label>æ€§åˆ¥</label><select id="gender"><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select></div>
        <div><label>ä½“é‡ (kg)</label><input type="number" id="weight" value="70" min="30" max="150"></div>
        <div><label>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ­´</label><select id="history"><option value="beginner">1å¹´æœªæº€ (åˆç´š)</option><option value="intermediate" selected>1-3å¹´ (ä¸­ç´š)</option><option value="advanced">3å¹´ä»¥ä¸Š (ä¸Šç´š)</option></select></div>
        <div><label>ç›®çš„</label><select id="goal"><option value="maintenance">å¥åº·ç¶­æŒ</option><option value="bulking">å¢—é‡ãƒ»ç­‹è‚¥å¤§</option><option value="cutting">æ¸›é‡ãƒ»å¼•ãç· ã‚</option></select></div>
    </div>

    <div class="section-title">è§£æ±ºã—ãŸã„èª²é¡Œï¼ˆè¤‡æ•°é¸æŠï¼‰</div>
    <div class="pain-grid" id="painGrid">
        <label class="check-card"><input type="checkbox" name="pain" value="pump"> ãƒ‘ãƒ³ãƒ—æ„Ÿãƒ»è¡€ç®¡æ‹¡å¼µ</label>
        <label class="check-card"><input type="checkbox" name="pain" value="s_plateau"> ç­‹åŠ›/é‡é‡ã®åœæ»</label>
        <label class="check-card"><input type="checkbox" name="pain" value="fatigue"> æ…¢æ€§ç–²åŠ´ãƒ»å›å¾©é…å»¶</label>
        <label class="check-card"><input type="checkbox" name="pain" value="doms"> ç­‹è‚‰ç—›ãŒå–ã‚Œãªã„</label>
        <label class="check-card"><input type="checkbox" name="pain" value="stress"> ã‚¹ãƒˆãƒ¬ã‚¹ãƒ»é›†ä¸­åŠ›</label>
        <label class="check-card"><input type="checkbox" name="pain" value="sleep"> ç¡çœ ã®è³ªãƒ»å¯èµ·ã</label>
        <label class="check-card"><input type="checkbox" name="pain" value="w_plateau"> è„‚è‚ªç‡ƒç„¼ãƒ»ä»£è¬</label>
        <label class="check-card"><input type="checkbox" name="pain" value="stomach"> èƒƒè…¸ãƒ»æ¶ˆåŒ–å¸å</label>
        <label class="check-card"><input type="checkbox" name="pain" value="joint"> é–¢ç¯€ç—›ãƒ»æ€ªæˆ‘äºˆé˜²</label>
        <label class="check-card"><input type="checkbox" name="pain" value="hormone"> æ´»åŠ›ãƒ»ç”·æ€§æ©Ÿèƒ½</label>
        <label class="check-card"><input type="checkbox" name="pain" value="skin"> è‚Œè’ã‚Œãƒ»æŠ—é…¸åŒ–</label>
    </div>

    <div class="advanced-settings">
        <div class="advanced-summary" onclick="document.getElementById('advContent').classList.toggle('show')">
            <span>âš™ï¸ è©³ç´°è¡¨ç¤ºè¨­å®š (ä»¶æ•°ãƒ»é–¾å€¤ãªã©)</span>
            <span>â–¼</span>
        </div>
        <div class="advanced-content" id="advContent">
            <div>
                <label>æœ€å¤§è¡¨ç¤ºä»¶æ•° (Lane B)</label>
                <select id="maxDisplay">
                    <option value="7">æ¨™æº– (7ä»¶)</option>
                    <option value="10">å¤šã‚ (10ä»¶)</option>
                    <option value="20">ã‹ãªã‚Šå¤šã‚ (20ä»¶)</option>
                    <option value="99">å…¨ä»¶è¡¨ç¤º</option>
                </select>
            </div>
            <div>
                <label>ææ¡ˆã®å³æ ¼ã• (ã‚¹ã‚³ã‚¢é–¾å€¤)</label>
                <select id="scoreThreshold">
                    <option value="10">æ¨™æº–</option>
                    <option value="0">ç·©å’Œ (å…¨ã¦è¡¨ç¤º)</option>
                    <option value="25">å³æ ¼ (ãƒãƒƒãƒåº¦é«˜)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="section-title">ç¾åœ¨æ‘‚å–ä¸­ã®ã‚µãƒ—ãƒª (Stack)</div>
    <div class="taken-grid" id="takenGrid"></div>

    <div class="section-title">å®‰å…¨æ€§ãƒ»ä½“è³ªãƒã‚§ãƒƒã‚¯</div>
    <div class="safety-grid">
        <label class="check-card"><input type="checkbox" name="safety" value="hi_bp"> é«˜è¡€åœ§æ°—å‘³</label>
        <label class="check-card"><input type="checkbox" name="safety" value="insomnia"> ä¸çœ ãƒ»ã‚«ãƒ•ã‚§ã‚¤ãƒ³éæ•</label>
        <label class="check-card"><input type="checkbox" name="safety" value="kidney"> è…æ©Ÿèƒ½ã«ä¸å®‰</label>
        <label class="check-card"><input type="checkbox" name="safety" value="thyroid"> ç”²çŠ¶è…ºç³»ç–¾æ‚£</label>
        <label class="check-card"><input type="checkbox" name="safety" value="meds"> å‡¦æ–¹è–¬ã‚’æœç”¨ä¸­</label>
    </div>

    <button class="btn-analyze" id="btnAnalyze">ã‚¹ã‚¿ãƒƒã‚¯æœ€é©åŒ– & ææ¡ˆç”Ÿæˆ</button>

    <div id="resultArea" class="result-area">
        <div class="report-tools">
            <button class="btn-tool" onclick="copyReport()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button class="btn-tool" onclick="window.print()">ğŸ–¨ï¸ å°åˆ· / PDF</button>
        </div>

        <div class="section-title">æ¨å¥¨æ‘‚å–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
        <div id="timeline" class="timeline"></div>
        
        <div class="lane-container" id="laneAContainer">
            <div class="lane-header"><span class="lane-badge lane-a-badge">Lane A</span> ç¾åœ¨ã®ã‚¹ã‚¿ãƒƒã‚¯ (ç¶™ç¶š/èª¿æ•´æ¨å¥¨)</div>
            <div id="laneAContent"></div>
        </div>
        
        <div class="lane-container" id="laneBContainer">
            <div class="lane-header"><span class="lane-badge lane-b-badge">Lane B</span> è¿½åŠ æ¨å¥¨ã‚µãƒ—ãƒªãƒ¡ãƒ³ãƒˆ (Priority)</div>
            <div id="laneBContent"></div>
        </div>
    </div>
</div>

<script>
    /* --- CONFIG & DATA --- */
    const safetyLabels = {
        hi_bp: "é«˜è¡€åœ§", insomnia: "ä¸çœ å‚¾å‘", kidney: "è…æ©Ÿèƒ½ä¸å®‰", thyroid: "ç”²çŠ¶è…ºç–¾æ‚£", meds: "æœè–¬ä¸­"
    };

    /* --- FULL DATABASE (34ç¨®) --- */
    const DB = [
        { id: 'citrulline', name: 'L-ã‚·ãƒˆãƒ«ãƒªãƒ³', level: 1, triggers: ['pump', 'doms', 'fatigue'], goalBonus: ['bulking'], timing: 'pre_workout', pmid: '20386132', pro: 'è¡€ç®¡æ‹¡å¼µ(NO)ã«ã‚ˆã‚‹æŒä¹…åŠ›ãƒ»ãƒ‘ãƒ³ãƒ—å‘ä¸Šã€‚', caution: 'ä½è¡€åœ§æ³¨æ„', priority: 9, dose: w => `6000-8000mg` },
        { id: 'sodium', name: 'ãƒŠãƒˆãƒªã‚¦ãƒ (å¡©åˆ†)', level: 1, triggers: ['pump', 'fatigue'], goalBonus: ['bulking'], timing: 'intra_workout', pmid: '25916908', pro: 'è¡€æµé‡ç¶­æŒã€å¼·çƒˆãªãƒ‘ãƒ³ãƒ—ã€æ”£ã‚Šé˜²æ­¢ã€‚', caution: 'é«˜è¡€åœ§å³ç¦', contra: 'hi_bp', priority: 8, dose: w => `1000-2000mg` },
        { id: 'beta_alanine', name: 'ãƒ™ãƒ¼ã‚¿ã‚¢ãƒ©ãƒ‹ãƒ³', level: 2, triggers: ['fatigue', 's_plateau'], goalBonus: ['bulking'], timing: 'pre_workout', pmid: '22270875', pro: 'ç­‹å†…ã‚«ãƒ«ãƒã‚·ãƒ³æ¿ƒåº¦UPã€ä¹³é…¸ç·©è¡ä½œç”¨ã€‚', caution: 'ãƒ”ãƒªãƒ”ãƒªæ„Ÿã‚ã‚Š', priority: 7, dose: w => `3.2g` },
        { id: 'creatine', name: 'ã‚¯ãƒ¬ã‚¢ãƒãƒ³', level: 1, triggers: ['s_plateau', 'pump'], goalBonus: ['bulking'], timing: 'post_workout', pmid: '28615996', pro: 'ATPå†åˆæˆã€ç¬ç™ºåŠ›ã€ç´°èƒå†…æ°´åˆ†ä¿æŒã€‚', caution: 'è…æ©Ÿèƒ½ä¸å®‰æ™‚ã¯è¦ç›¸è«‡', contra: 'kidney', priority: 10, dose: w => `${Math.round(w*0.05)}g` },
        { id: 'beetroot', name: 'ãƒ“ãƒ¼ãƒˆãƒ«ãƒ¼ãƒˆ(ç¡é…¸å¡©)', level: 2, triggers: ['pump', 'fatigue'], goalBonus: ['cutting'], timing: 'pre_workout', pmid: '23640589', pro: 'å¤©ç„¶ã®NOãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ã€‚æœ‰é…¸ç´ æŒä¹…åŠ›ã€‚', caution: 'ä½è¡€åœ§æ³¨æ„', priority: 6, dose: w => `300-500mg(ç¡é…¸å¡©æ›ç®—)` },
        { id: 'eaa', name: 'EAA (å¿…é ˆã‚¢ãƒŸãƒé…¸)', level: 2, triggers: ['fatigue', 'doms'], goalBonus: ['bulking', 'cutting'], timing: 'intra_workout', pmid: '28919842', pro: 'ç­‹åˆ†è§£æŠ‘åˆ¶ã€åˆæˆä¿ƒé€²ã€‚', caution: 'ä¸€æ°—é£²ã¿ã¯ä¸‹ç—¢æ³¨æ„', priority: 7, dose: w => `10-15g` },
        { id: 'hmb', name: 'HMB', level: 2, triggers: ['doms', 'fatigue'], goalBonus: ['cutting'], timing: 'pre_workout', pmid: '23241341', pro: 'æŠ—ã‚«ã‚¿ãƒœãƒªãƒƒã‚¯(åˆ†è§£æŠ‘åˆ¶)ã€‚åˆå¿ƒè€…ã«æœ‰åŠ¹ã€‚', caution: 'ä¸Šç´šè€…ã«ã¯åŠ¹æœè–„', priority: 3, dose: w => `3000mg` },
        { id: 'caffeine', name: 'ã‚«ãƒ•ã‚§ã‚¤ãƒ³', level: 1, triggers: ['w_plateau', 'fatigue'], goalBonus: ['cutting'], timing: 'pre_workout', pmid: '2912010', pro: 'è¦šé†’ã€ç­‹åç¸®åŠ›å‘ä¸Šã€è„‚è‚ªé…¸åŒ–ã€‚', caution: 'å‹•æ‚¸ãƒ»ä¸çœ ', contra: 'insomnia', priority: 7, dose: w => `${Math.round(w*3)}-${Math.round(w*5)}mg` },
        { id: 'theanine', name: 'L-ãƒ†ã‚¢ãƒ‹ãƒ³', level: 1, triggers: ['stress', 'fatigue'], goalBonus: ['maintenance'], timing: 'pre_workout', pmid: '18681988', pro: 'ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã®å‰¯ä½œç”¨ç·©å’Œã€é›†ä¸­åŠ›ã€‚', caution: 'ç‰¹ã«ãªã—', priority: 6, dose: w => `200mg` },
        { id: 'tyrosine', name: 'L-ãƒãƒ­ã‚·ãƒ³', level: 2, triggers: ['stress', 'fatigue'], goalBonus: ['cutting'], timing: 'pre_workout', pmid: '26424423', pro: 'ãƒ‰ãƒ¼ãƒ‘ãƒŸãƒ³å‰é§†ä½“ã€‚ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§ã€‚', caution: 'ç”²çŠ¶è…ºæ©Ÿèƒ½äº¢é€²æ™‚ã¯æ³¨æ„', contra: 'thyroid', priority: 5, dose: w => `1000-2000mg` },
        { id: 'carnitine', name: 'L-ã‚«ãƒ«ãƒ‹ãƒãƒ³', level: 2, triggers: ['w_plateau'], goalBonus: ['cutting'], timing: 'pre_workout', pmid: '29381391', pro: 'è„‚è‚ªé…¸è¼¸é€ã‚µãƒãƒ¼ãƒˆã€‚æ¸›é‡åœæ»æœŸã«ã€‚', caution: 'ç¶™ç¶šæ‘‚å–ãŒå¿…è¦', priority: 6, dose: w => `2000mg` },
        { id: 'berberine', name: 'ãƒ™ãƒ«ãƒ™ãƒªãƒ³', level: 3, triggers: ['w_plateau'], goalBonus: ['cutting', 'maintenance'], timing: 'pre_meal', pmid: '18442638', pro: 'GDA(ç³–åˆ©ç”¨ä¿ƒé€²)ã€è¡€ç³–å€¤ã‚±ã‚¢ã€‚', caution: 'ä½è¡€ç³–ãƒªã‚¹ã‚¯ã€æœè–¬ä¸­æ³¨æ„', contra: 'meds', priority: 6, dose: w => `500mg(ç‚­æ°´åŒ–ç‰©å‰)` },
        { id: 'cla', name: 'CLA (å…±å½¹ãƒªãƒãƒ¼ãƒ«é…¸)', level: 2, triggers: ['w_plateau'], goalBonus: ['cutting'], timing: 'with_meal', pmid: '17490954', pro: 'è„‚è‚ªåˆ†è§£é…µç´ ã®æ´»æ€§åŒ–ã€‚', caution: 'åŠ¹æœã«ã¯å€‹äººå·®ã‚ã‚Š', priority: 4, dose: w => `3000mg` },
        { id: 'ashwagandha', name: 'ã‚¢ã‚·ãƒ¥ãƒ¯ã‚¬ãƒ³ãƒ€', level: 3, triggers: ['stress', 'hormone', 'sleep'], goalBonus: ['bulking'], timing: 'dinner', pmid: '23439798', pro: 'ã‚³ãƒ«ãƒã‚¾ãƒ¼ãƒ«æŠ‘åˆ¶ã€ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒ­ãƒ³ç¶­æŒã€‚', caution: 'ç”²çŠ¶è…º/è‡ªå·±å…ç–«ç–¾æ‚£ã¯æ³¨æ„', contra: 'thyroid', priority: 7, dose: w => `300-600mg` },
        { id: 'magnesium', name: 'ãƒã‚°ãƒã‚·ã‚¦ãƒ ', level: 1, triggers: ['sleep', 'stress', 'doms', 'joint'], goalBonus: ['maintenance'], timing: 'before_sleep', pmid: '23853635', pro: 'ç¥çµŒé®é™ã€ç¡çœ æ”¹å–„ã€ç­‹å¼›ç·©ã€‚', caution: 'è…æ©Ÿèƒ½ä½ä¸‹æ™‚ã¯ãƒªã‚¹ã‚¯', contra: 'kidney', priority: 9, dose: w => `200-400mg` },
        { id: 'glycine', name: 'ã‚°ãƒªã‚·ãƒ³', level: 2, triggers: ['sleep', 'skin'], goalBonus: ['maintenance'], timing: 'before_sleep', pmid: '22293292', pro: 'æ·±éƒ¨ä½“æ¸©ä½ä¸‹ã«ã‚ˆã‚‹å…¥çœ ã‚µãƒãƒ¼ãƒˆã€‚', caution: 'ç‰¹ã«ãªã—', priority: 6, dose: w => `3000mg` },
        { id: 'melatonin', name: 'ãƒ¡ãƒ©ãƒˆãƒ‹ãƒ³', level: 2, triggers: ['sleep'], goalBonus: ['maintenance'], timing: 'before_sleep', pmid: '24558197', pro: 'å…¥çœ æ½œæ™‚ã®çŸ­ç¸®ã€‚æ¦‚æ—¥ãƒªã‚ºãƒ èª¿æ•´ã€‚', caution: 'ãƒ›ãƒ«ãƒ¢ãƒ³å‰¤ã®ãŸã‚å°‘é‡ã‹ã‚‰', priority: 5, dose: w => `1-3mg` },
        { id: 'rhodiola', name: 'ãƒ­ãƒ‡ã‚£ã‚ªãƒ©', level: 2, triggers: ['stress', 'fatigue'], goalBonus: ['maintenance'], timing: 'morning', pmid: '22228617', pro: 'ã‚¢ãƒ€ãƒ—ãƒˆã‚²ãƒ³ã€‚æŠ—ç–²åŠ´ã€ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆäºˆé˜²ã€‚', caution: 'å¤•æ–¹ä»¥é™ã¯é¿ã‘ã‚‹', priority: 5, dose: w => `200-400mg` },
        { id: 'boron', name: 'ãƒ›ã‚¦ç´  (Boron)', level: 3, triggers: ['hormone'], goalBonus: ['bulking'], timing: 'with_meal', pmid: '21129261', pro: 'SHBGæ¸›å°‘ã€éŠé›¢ãƒ†ã‚¹ãƒˆã‚¹ãƒ†ãƒ­ãƒ³å¢—åŠ ã€‚', caution: 'é•·æœŸé€£ç”¨ã‚’é¿ã‘ã‚µã‚¤ã‚¯ãƒ«åŒ–', priority: 5, dose: w => `3-10mg` },
        { id: 'vit_d', name: 'ãƒ“ã‚¿ãƒŸãƒ³D3', level: 1, triggers: ['hormone', 'stress', 'joint'], goalBonus: ['maintenance'], timing: 'morning', pmid: '21154195', pro: 'å…ç–«ã€éª¨å¯†åº¦ã€ãƒ¡ãƒ³ã‚¿ãƒ«å®‰å®šã€‚', caution: 'è„‚æº¶æ€§(é£Ÿäº‹å¿…é ˆ)', priority: 9, dose: w => `2000-5000IU` },
        { id: 'zinc', name: 'äºœé‰›', level: 1, triggers: ['hormone', 'fatigue', 'skin'], goalBonus: ['bulking'], timing: 'before_sleep', pmid: '8875519', pro: 'ç´°èƒåˆ†è£‚ã€ãƒ›ãƒ«ãƒ¢ãƒ³åˆæˆã€å‘³è¦šã€‚', caution: 'ç©ºè…¹æ™‚åãæ°—', priority: 8, dose: w => `15-30mg` },
        { id: 'omega3', name: 'ã‚ªãƒ¡ã‚¬3 (EPA/DHA)', level: 1, triggers: ['joint', 'stress', 'skin'], goalBonus: ['maintenance', 'cutting'], timing: 'with_meal', pmid: '21784145', pro: 'æŠ—ç‚ç—‡ã€é–¢ç¯€ä¿è­·ã€è¡€ä¸­è„‚è³ªæ”¹å–„ã€‚', caution: 'è¡€æ¶²å‡å›ºé˜»æ­¢è–¬æœç”¨æ™‚ã¯ç›¸è«‡', contra: 'meds', priority: 9, dose: w => `2000-3000mg` },
        { id: 'multivitamin', name: 'ãƒãƒ«ãƒãƒ“ã‚¿ãƒŸãƒ³', level: 1, triggers: ['fatigue', 'skin'], goalBonus: ['maintenance'], timing: 'morning', pmid: '22987599', pro: 'å¾®é‡æ „é¤Šç´ ã®åº•ä¸Šã’ã€‚', caution: 'å°¿ãŒé»„è‰²ããªã‚‹(B2)', priority: 6, dose: w => `è¦å®šé‡` },
        { id: 'vit_c', name: 'ãƒ“ã‚¿ãƒŸãƒ³C', level: 1, triggers: ['skin', 'stress', 'fatigue'], goalBonus: ['maintenance', 'cutting'], timing: 'anytime', pmid: '23927692', pro: 'æŠ—é…¸åŒ–ã€ã‚³ãƒ«ãƒã‚¾ãƒ¼ãƒ«æŠ‘åˆ¶ã€ã‚³ãƒ©ãƒ¼ã‚²ãƒ³åˆæˆã€‚', caution: 'ä¸€åº¦ã«å¤§é‡æ‘‚å–ã™ã‚‹ã¨ä¸‹ç—¢ã®å¯èƒ½æ€§', priority: 8, dose: w => `1000-2000mg` },
        { id: 'vit_e', name: 'ãƒ“ã‚¿ãƒŸãƒ³E', level: 2, triggers: ['skin', 'hormone'], goalBonus: ['maintenance'], timing: 'with_meal', pmid: '27559512', pro: 'å¼·åŠ›ãªæŠ—é…¸åŒ–ã€è¡€æµæ”¹å–„ã€‚', caution: 'è„‚æº¶æ€§', priority: 6, dose: w => `400IU` },
        { id: 'glucosamine', name: 'ã‚°ãƒ«ã‚³ã‚µãƒŸãƒ³', level: 1, triggers: ['joint'], goalBonus: ['maintenance'], timing: 'with_meal', pmid: '16461376', pro: 'é–¢ç¯€è»Ÿéª¨ã®ä¿è­·ãƒ»ä¿®å¾©ã€‚', caution: 'ç”²æ®»é¡ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æ³¨æ„', priority: 6, dose: w => `1500mg` },
        { id: 'collagen', name: 'ã‚³ãƒ©ãƒ¼ã‚²ãƒ³ãƒšãƒ—ãƒãƒ‰', level: 1, triggers: ['joint', 'skin'], goalBonus: ['maintenance'], timing: 'anytime', pmid: '18416885', pro: 'é–¢ç¯€ç—›ç·©å’Œã€è‚Œå¼¾åŠ›ã€‚', caution: 'ç‰¹ã«ãªã—', priority: 6, dose: w => `5-10g` },
        { id: 'coq10', name: 'CoQ10 (é‚„å…ƒå‹)', level: 2, triggers: ['fatigue', 'skin'], goalBonus: ['maintenance'], timing: 'with_meal', pmid: '20691130', pro: 'ãƒŸãƒˆã‚³ãƒ³ãƒ‰ãƒªã‚¢æ´»æ€§åŒ–ã€æŠ—é…¸åŒ–ã€‚', caution: 'è„‚æº¶æ€§', priority: 6, dose: w => `100mg` },
        { id: 'glutamine', name: 'L-ã‚°ãƒ«ã‚¿ãƒŸãƒ³', level: 1, triggers: ['stomach', 'doms'], goalBonus: ['bulking'], timing: 'post_workout', pmid: '29462271', pro: 'è…¸ç®¡ç²˜è†œä¿®å¾©ã€å…ç–«èƒ½ç¶­æŒã€‚', caution: 'ç‰¹ã«ãªã—', priority: 7, dose: w => `5g` },
        { id: 'probiotics', name: 'ãƒ—ãƒ­ãƒã‚¤ã‚ªãƒ†ã‚£ã‚¯ã‚¹', level: 1, triggers: ['stomach'], goalBonus: ['maintenance'], timing: 'morning', pmid: '24912204', pro: 'è…¸å†…ãƒ•ãƒ­ãƒ¼ãƒ©æ”¹å–„ã€æ¶ˆåŒ–å¸åã€‚', caution: 'åˆæœŸã«ã‚¬ã‚¹æºœã¾ã‚Šã®å¯èƒ½æ€§', priority: 6, dose: w => `1-2ã‚«ãƒ—ã‚»ãƒ«` },
        { id: 'fiber', name: 'é£Ÿç‰©ç¹Šç¶­(ã‚µã‚¤ãƒªã‚¦ãƒ ç­‰)', level: 1, triggers: ['stomach', 'w_plateau'], goalBonus: ['cutting'], timing: 'with_meal', pmid: '28612143', pro: 'è¡€ç³–å€¤å®‰å®šã€ä¾¿é€šæ”¹å–„ã€æº€è…¹æ„Ÿã€‚', caution: 'æ°´åˆ†å¿…é ˆ', priority: 6, dose: w => `5-10g` },
        { id: 'digestive_enzymes', name: 'æ¶ˆåŒ–é…µç´ ', level: 1, triggers: ['stomach'], goalBonus: ['bulking'], timing: 'with_meal', pmid: '29878239', pro: 'æ „é¤Šç´ ã®åˆ†è§£å¸åã‚’è£œåŠ©ã€‚', caution: 'é£Ÿç›´å‰ã«æ‘‚å–', priority: 5, dose: w => `è¦å®šé‡` },
        { id: 'iron', name: 'é‰„åˆ† (ãƒ˜ãƒ é‰„)', level: 1, triggers: ['fatigue'], goalBonus: ['maintenance'], timing: 'with_meal', pmid: '24914241', pro: 'é…¸ç´ é‹æ¬ã€è²§è¡€äºˆé˜²ã€‚', caution: 'ç”·æ€§ã¯æ¬ ä¹ç—‡ä»¥å¤–æ‘‚å–ã—ãªã„', genderOnly: 'female', priority: 6, dose: w => `10-20mg` },
        { id: 'maca', name: 'ãƒã‚«', level: 1, triggers: ['hormone', 'fatigue'], goalBonus: ['maintenance'], timing: 'morning', pmid: '19781622', pro: 'æ»‹é¤Šå¼·å£®ã€ãƒ›ãƒ«ãƒ¢ãƒ³ãƒãƒ©ãƒ³ã‚¹ã€‚', caution: 'ç‰¹ã«ãªã—', priority: 5, dose: w => `1500-3000mg` }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        // Init Taken Grid
        const grid = document.getElementById('takenGrid');
        DB.forEach(s => {
            const label = document.createElement('label');
            label.className = 'check-card taken-card';
            label.innerHTML = `<input type="checkbox" name="taken" value="${s.id}"> ${s.name}`;
            grid.appendChild(label);
        });

        document.getElementById('btnAnalyze').addEventListener('click', analyze);
    });

    function analyze() {
        const weight = parseFloat(document.getElementById('weight').value) || 70;
        const gender = document.getElementById('gender').value;
        const history = document.getElementById('history').value;
        const goal = document.getElementById('goal').value;
        const pains = Array.from(document.querySelectorAll('input[name="pain"]:checked')).map(c => c.value);
        const takens = Array.from(document.querySelectorAll('input[name="taken"]:checked')).map(c => c.value);
        const safeties = Array.from(document.querySelectorAll('input[name="safety"]:checked')).map(c => c.value);
        const maxDisplay = parseInt(document.getElementById('maxDisplay').value);
        const threshold = parseInt(document.getElementById('scoreThreshold').value);

        const resArea = document.getElementById('resultArea');
        const lA = document.getElementById('laneAContent');
        const lB = document.getElementById('laneBContent');
        
        lA.innerHTML = ''; lB.innerHTML = ''; 

        if(pains.length === 0 && takens.length === 0) {
            alert("æ‚©ã¿ã¾ãŸã¯ç¾åœ¨ã®ã‚µãƒ—ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return;
        }

        // Logic & Scoring
        let results = DB.map(s => {
            if (s.genderOnly && s.genderOnly !== gender) return null;
            let score = 0;
            let matchLogs = [];
            let warnings = [];

            // A. Trigger Match (Pump Boost Integrated)
            s.triggers.forEach(t => {
                if(pains.includes(t)) {
                    let pts = 20;
                    if(t === 'pump') pts = 40; 
                    if(t === 'w_plateau' && s.id === 'carnitine') pts = 35;
                    score += pts; matchLogs.push(t);
                }
            });

            // B. Goal Bonus
            if(s.goalBonus && s.goalBonus.includes(goal)) {
                score += 15; matchLogs.push(`ç›®çš„(${goal})`);
            }

            // C. History/Level
            const level = s.level || 1;
            score += (s.priority * 3); 
            if(history === 'beginner' && level >= 2) score -= 20;
            if(history === 'advanced' && level >= 2) score += 15;

            // D. Multi-Safety Check (Independent Ifs)
            if(s.contra && safeties.includes(s.contra)) {
                score = -999; warnings.push(`âš ï¸ ç¦å¿Œ: ${safetyLabels[s.contra]} (${s.caution})`);
            }
            if(safeties.includes('meds')) {
                 if(['omega3','ashwagandha','vit_d','berberine'].includes(s.id)) warnings.push('âš ï¸ è–¬ã¨ã®é£²ã¿åˆã‚ã›æ³¨æ„');
            } 
            if(safeties.includes('insomnia') && s.id === 'caffeine') {
                warnings.push('âš ï¸ ä¸çœ æ‚ªåŒ–ãƒªã‚¹ã‚¯');
            }
            if(safeties.includes('hi_bp') && s.id === 'sodium') {
                warnings.push('âš ï¸ è¡€åœ§ä¸Šæ˜‡ãƒªã‚¹ã‚¯');
            }

            // Normalization
            if(pains.length > 0) score = score / (1 + (Math.log(pains.length + 1) * 0.5));

            return { ...s, finalScore: score, matchLogs, warnings, isTaken: takens.includes(s.id), calcDose: s.dose(weight) };
        }).filter(x => x !== null);

        // Sorting & Filtering
        const takenItems = results.filter(d => d.isTaken);
        let recItems = results.filter(d => !d.isTaken && d.finalScore >= threshold);
        
        // Auto-Recovery
        if (recItems.length === 0) recItems = results.filter(d => !d.isTaken && d.finalScore > 0);
        recItems.sort((a,b) => b.finalScore - a.finalScore);

        resArea.style.display = 'block';

        // Render Lane A
        if(takenItems.length > 0) {
            takenItems.forEach(item => lA.innerHTML += createCard(item, 'a'));
        } else {
            lA.innerHTML = '<div class="fallback-card">é¸æŠã•ã‚ŒãŸã‚µãƒ—ãƒªã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        }

        // Render Lane B
        const displayItems = recItems.slice(0, maxDisplay);
        if(displayItems.length > 0) {
            displayItems.forEach(item => lB.innerHTML += createCard(item, 'b'));
        } else {
            lB.innerHTML = `<div class="fallback-card">ææ¡ˆå€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>å®‰å…¨ãƒã‚§ãƒƒã‚¯ã«ã‚ˆã‚‹é™¤å¤–ã¾ãŸã¯æ¡ä»¶ã®å³æ ¼ã•ãŒå½±éŸ¿ã—ã¦ã„ã¾ã™ã€‚</div>`;
        }

        // Timeline Sync (Taken + Displayed Recommendations)
        renderTimeline([...takenItems, ...displayItems]);
        window.scrollTo({ top: resArea.offsetTop - 20, behavior: 'smooth' });
    }

    function createCard(item, lane) {
        const warnHtml = item.warnings.length > 0 ? 
            `<div class="warning-box">${item.warnings.map(w => `<div class="warning-line">${w}</div>`).join('')}</div>` : '';
        const scoreInfo = lane === 'b' ? `Score: ${Math.round(item.finalScore)}` : 'ç¶™ç¶šä¸­';
        const reasons = item.matchLogs.length > 0 ? `ç†ç”±: ${item.matchLogs.join(', ')}` : 'åŸºç¤æ „é¤Šãƒ»ç›®çš„åˆè‡´';
        
        return `
            <div class="detail-card card-lane-${lane} ${item.warnings.length > 0 ? 'warning' : ''}">
                <div class="card-top">
                    <div class="supp-name">${item.name}</div>
                    <div class="supp-score">${scoreInfo}</div>
                </div>
                <div class="reason-row">${reasons}</div>
                <div class="info-row" style="margin-top:8px;"><span class="info-label">ç›®çš„</span> <span class="info-val">${item.pro}</span></div>
                <div class="info-row"><span class="info-label">æ¨å¥¨é‡</span> <span class="info-val" style="font-weight:bold;">${item.calcDose}</span></div>
                <div class="info-row"><span class="info-label">ã‚¿ã‚¤ãƒŸãƒ³ã‚°</span> <span class="info-val">${formatT(item.timing)}</span></div>
                ${warnHtml}
                <div style="margin-top:8px; font-size:0.7rem; text-align:right;"><a href="https://pubmed.ncbi.nlm.nih.gov/${item.pmid}/" target="_blank" style="color:var(--accent); text-decoration:none;">PubMed Evidence â†—</a></div>
            </div>`;
    }

    function formatT(t) {
        const m = {
            pre_workout:'ãƒˆãƒ¬å‰', intra_workout:'ãƒˆãƒ¬ä¸­', post_workout:'ãƒˆãƒ¬å¾Œ', 
            morning:'æœ', with_meal:'é£Ÿå¾Œ', pre_meal:'é£Ÿå‰(ç‚­æ°´åŒ–ç‰©å‰)', 
            before_sleep:'å°±å¯å‰', dinner:'å¤•é£Ÿå¾Œ', anytime:'ã„ã¤ã§ã‚‚'
        };
        return m[t] || t;
    }

    function renderTimeline(items) {
        const slots = {};
        const order = ['morning', 'pre_meal', 'with_meal', 'pre_workout', 'intra_workout', 'post_workout', 'dinner', 'before_sleep', 'anytime'];
        order.forEach(k => slots[k] = []);
        const labels = {
            morning:'æœ', pre_meal:'é£Ÿå‰(ç‚­æ°´åŒ–ç‰©)', with_meal:'é£Ÿå¾Œ', 
            pre_workout:'ãƒˆãƒ¬å‰', intra_workout:'ãƒˆãƒ¬ä¸­', post_workout:'ãƒˆãƒ¬å¾Œ', 
            dinner:'å¤•é£Ÿå¾Œ', before_sleep:'å°±å¯å‰', anytime:'è‡ªç”±'
        };
        
        items.forEach(it => { 
            if(slots[it.timing]) slots[it.timing].push(`<span class="supp-pill ${it.isTaken ? 'pill-take' : 'pill-add'}">${it.name}</span>`);
        });
        
        const tlDiv = document.getElementById('timeline');
        tlDiv.innerHTML = '';
        order.forEach(k => {
            if(slots[k].length > 0) tlDiv.innerHTML += `
                <div class="time-slot"><div class="time-label">${labels[k]}</div><div class="time-content">${slots[k].join('')}</div></div>`;
        });
    }

    function copyReport() {
        const lA = document.getElementById('laneAContent').innerText;
        const lB = document.getElementById('laneBContent').innerText;
        const tl = document.getElementById('timeline').innerText.replace(/\n/g, ' ');
        const text = `ã€Supplement Reportã€‘\n\n[ç¾åœ¨æ‘‚å–ä¸­]\n${lA}\n\n[è¿½åŠ æ¨å¥¨]\n${lB}\n\n[ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«]\n${tl}\n\nâ€»æœ¬ææ¡ˆã¯åŒ»ç™‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
        navigator.clipboard.writeText(text).then(() => alert('ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
    }
</script>
</body>
</html>
